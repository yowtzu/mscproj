from lxml.html import parse
from urllib.request import urlopen
from pandas.io.parsers import TextParser

class YahooAnalystOpinionsFeed:
    
    def __init__(self, ticker):
        self.parsed = parse(urlopen('http://finance.yahoo.com/q/op?s=%s', ticker))
        self.doc = parsed.getroot()
        self.tables = doc.findall('.//table')
        self.table = self.tables[8]

    def _unpack(self, row, tag='td'):
        elts = row.findall('.//%s' % tag)
        return [val.text_content() for val in elts]

    def parse(self):
        rows = self.table.findall('.//tr')
        header = _unpack(row[0], kind='th')
        data = [_unpack(r) for r in rows[1:]]
        return TextParser(data, names=header).get_chuck()

